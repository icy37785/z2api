<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ZtoApi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-3">📊 Dashboard</h1>
            <p class="text-gray-600">实时监控 API 请求和性能统计</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition">
                <p class="text-gray-600 text-sm mb-1">总请求数</p>
                <p class="text-3xl font-bold text-gray-900" id="total">0</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition">
                <p class="text-gray-600 text-sm mb-1">成功请求</p>
                <p class="text-3xl font-bold text-green-600" id="success">0</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition">
                <p class="text-gray-600 text-sm mb-1">失败请求</p>
                <p class="text-3xl font-bold text-red-600" id="failed">0</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition">
                <p class="text-gray-600 text-sm mb-1">平均响应时间</p>
                <p class="text-3xl font-bold text-blue-600" id="avgtime">0ms</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition">
                <p class="text-gray-600 text-sm mb-1">首页访问</p>
                <p class="text-3xl font-bold text-indigo-600" id="homeviews">0</p>
            </div>
        </div>

        <!-- Detailed Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- API Stats -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">API 统计</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">Chat Completions</span><span class="font-bold text-purple-600" id="api-calls">0</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">Models 查询</span><span class="font-bold text-purple-600" id="models-calls">0</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">流式请求</span><span class="font-bold text-blue-600" id="streaming">0</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">非流式请求</span><span class="font-bold text-blue-600" id="non-streaming">0</span></div>
                </div>
            </div>

            <!-- Performance Stats -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">性能指标</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">平均响应</span><span class="font-bold text-blue-600" id="avg-time-detail">0ms</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">最快响应</span><span class="font-bold text-green-600" id="fastest">0ms</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">最慢响应</span><span class="font-bold text-orange-600" id="slowest">0ms</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">成功率</span><span class="font-bold text-green-600" id="success-rate">0%</span></div>
                </div>
            </div>

            <!-- System Info -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">系统信息</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">运行时长</span><span class="font-bold text-indigo-600" id="uptime">0</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">Token 使用</span><span class="font-bold text-indigo-600" id="tokens">0</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">最后请求</span><span class="font-bold text-gray-600 text-xs" id="last-request">-</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600 text-sm">首页访问</span><span class="font-bold text-indigo-600" id="home-visits">0</span></div>
                </div>
            </div>
        </div>

        <!-- Top Models Card -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-900 mb-4">热门模型 Top 3</h3>
            <div id="top-models" class="space-y-3">
                <p class="text-gray-500 text-sm">暂无数据</p>
            </div>
        </div>
    </div>
    <script>
        async function update() {
            try {
                const statsRes = await fetch('/dashboard/stats');
                const stats = await statsRes.json();

                document.getElementById('total').textContent = stats.totalRequests;
                document.getElementById('success').textContent = stats.successfulRequests;
                document.getElementById('failed').textContent = stats.failedRequests;
                document.getElementById('avgtime').textContent = Math.round(stats.averageResponseTime) + 'ms';
                document.getElementById('homeviews').textContent = stats.homePageViews;
                document.getElementById('api-calls').textContent = stats.apiCallsCount || 0;
                document.getElementById('models-calls').textContent = stats.modelsCallsCount || 0;
                document.getElementById('streaming').textContent = stats.streamingRequests || 0;
                document.getElementById('non-streaming').textContent = stats.nonStreamingRequests || 0;
                document.getElementById('avg-time-detail').textContent = Math.round(stats.averageResponseTime) + 'ms';
                document.getElementById('fastest').textContent = stats.fastestResponse === Infinity ? '-' : Math.round(stats.fastestResponse) + 'ms';
                document.getElementById('slowest').textContent = stats.slowestResponse === 0 ? '-' : Math.round(stats.slowestResponse) + 'ms';
                const successRate = stats.totalRequests > 0 ? ((stats.successfulRequests / stats.totalRequests) * 100).toFixed(1) : '0';
                document.getElementById('success-rate').textContent = successRate + '%';
                const uptime = Date.now() - new Date(stats.startTime).getTime();
                const hours = Math.floor(uptime / 3600000);
                const minutes = Math.floor((uptime % 3600000) / 60000);
                document.getElementById('uptime').textContent = hours + 'h ' + minutes + 'm';
                document.getElementById('tokens').textContent = (stats.totalTokensUsed || 0).toLocaleString();
                document.getElementById('last-request').textContent = stats.lastRequestTime ? new Date(stats.lastRequestTime).toLocaleTimeString() : '-';
                document.getElementById('home-visits').textContent = stats.homePageViews;

                const topModelsDiv = document.getElementById('top-models');
                if (stats.topModels && stats.topModels.length > 0) {
                    topModelsDiv.innerHTML = stats.topModels.map(function(m, i) {
                        return '<div class="flex items-center justify-between">' +
                            '<div class="flex items-center gap-2">' +
                            '<span class="font-mono text-sm text-gray-700">' + m.model + '</span>' +
                            '</div>' +
                            '<span class="font-bold text-purple-600">' + m.count + '</span>' +
                            '</div>';
                    }).join('');
                } else {
                    topModelsDiv.innerHTML = '<p class="text-gray-500 text-sm">暂无数据</p>';
                }
            } catch (e) {
                console.error('Update error:', e);
            }
        }
        update();
        setInterval(update, 5000);
    </script>
</body>
</html>